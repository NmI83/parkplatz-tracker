<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üöó Parkplatz Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            color: white;
        }
        
        .app {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 40px;
            max-width: 500px;
            width: 100%;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        h1 {
            font-size: 2.5em;
            margin-bottom: 30px;
            text-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        
        .status {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            font-size: 1.1em;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .phone-input {
            width: 100%;
            padding: 18px;
            border: none;
            border-radius: 15px;
            font-size: 16px;
            margin: 15px 0;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            text-align: center;
        }
        
        .phone-input:focus {
            outline: 3px solid rgba(255, 255, 255, 0.5);
            background: white;
        }
        
        .location-box {
            background: rgba(0, 255, 0, 0.1);
            border: 2px solid rgba(0, 255, 0, 0.3);
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            text-align: left;
        }
        
        .location-box h3 {
            color: #4ade80;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .location-box p {
            margin: 8px 0;
            line-height: 1.4;
        }
        
        .loading {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 10px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error {
            background: rgba(255, 0, 0, 0.15);
            border: 2px solid rgba(255, 0, 0, 0.3);
            color: #ff6b6b;
        }
        
        .success {
            background: rgba(0, 255, 0, 0.15);
            border: 2px solid rgba(0, 255, 0, 0.3);
            color: #4ade80;
        }
        
        .hidden {
            display: none;
        }
        
        .emoji {
            font-size: 1.5em;
            margin: 0 5px;
        }
    </style>
</head>
<body>
    <div class="app">
        <h1>üöó Parkplatz Tracker</h1>
        
        <!-- Telefonnummer Eingabe -->
        <div id="phoneSetup">
            <div class="status">
                üì± Einmalig Handynummer eingeben:
            </div>
            <input 
                type="tel" 
                id="phoneInput" 
                class="phone-input" 
                placeholder="+49 170 1234567"
                autocomplete="tel"
            >
            <div style="font-size: 0.9em; opacity: 0.8; margin-top: 10px;">
                Nach Eingabe startet automatisch die Ortung
            </div>
        </div>
        
        <!-- Lade-Status -->
        <div id="loadingStatus" class="status hidden">
            <div class="loading"></div>
            <div>üìç Ermittle deine Position...</div>
        </div>
        
        <!-- Erfolgreich gespeichert -->
        <div id="locationResult" class="location-box hidden">
            <h3>‚úÖ Parkposition gespeichert!</h3>
            <p><strong>üìç Koordinaten:</strong> <span id="coords"></span></p>
            <p><strong>üè† Adresse:</strong> <span id="address">Wird ermittelt...</span></p>
            <p><strong>üïê Zeit:</strong> <span id="time"></span></p>
            <p style="text-align: center; margin-top: 15px; color: #4ade80;">
                <strong>üì® SMS wird automatisch ge√∂ffnet!</strong>
            </p>
        </div>
        
        <!-- Fehler -->
        <div id="errorStatus" class="status error hidden">
            <div id="errorMessage">‚ùå Ein Fehler ist aufgetreten</div>
        </div>
    </div>

    <script>
        // Globale Variablen
        let phoneNumber = '';
        let currentLocation = null;
        
        // localStorage-Hilfsfunktionen
        function safeLocalStorageGet(key) {
            try {
                return localStorage.getItem(key);
            } catch (error) {
                console.warn('‚ö†Ô∏è localStorage.getItem fehlgeschlagen:', error);
                return null;
            }
        }
        
        function safeLocalStorageSet(key, value) {
            try {
                localStorage.setItem(key, value);
                return true;
            } catch (error) {
                console.warn('‚ö†Ô∏è localStorage.setItem fehlgeschlagen:', error);
                return false;
            }
        }

        // App initialisieren
        window.addEventListener('load', function() {
            console.log('üöó Parkplatz Tracker gestartet');
            console.log('üì± User Agent:', navigator.userAgent);
            initializeApp();
        });

        function initializeApp() {
            console.log('üîß App wird initialisiert...');
            
            // Sichere localStorage-Abfrage mit Hilfsfunktion
            const savedPhone = safeLocalStorageGet('parkingtrackerphone');
            console.log('üìû Gespeicherte Nummer:', savedPhone ? 'Vorhanden' : 'Nicht vorhanden');
            
            if (savedPhone) {
                phoneNumber = savedPhone;
                document.getElementById('phoneInput').value = savedPhone;
                console.log('‚úÖ Telefonnummer geladen, starte Ortung...');
                startLocationProcess();
            } else {
                console.log('üìù Warte auf Telefonnummer-Eingabe...');
                setupPhoneInput();
            }
        }

        function setupPhoneInput() {
            const phoneInput = document.getElementById('phoneInput');
            
            // Bei Eingabe
            phoneInput.addEventListener('input', function() {
                const phone = this.value.trim();
                if (phone.length >= 10) {
                    savePhoneAndStart(phone);
                }
            });
            
            // Bei Enter
            phoneInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    const phone = this.value.trim();
                    if (phone.length >= 10) {
                        savePhoneAndStart(phone);
                    }
                }
            });
        }

        function savePhoneAndStart(phone) {
            console.log('üíæ Speichere Telefonnummer:', phone);
            phoneNumber = phone;
            
            // Sichere localStorage-Speicherung mit Hilfsfunktion
            const success = safeLocalStorageSet('parkingtrackerphone', phone);
            if (success) {
                console.log('‚úÖ Nummer in localStorage gespeichert');
            } else {
                console.log('üìù Nummer nur f√ºr diese Session gespeichert');
            }
            
            console.log('üöÄ Starte Ortungsprozess...');
            startLocationProcess();
        }

        function startLocationProcess() {
            console.log('üìç Starte Geolocation...');
            
            // UI umschalten
            document.getElementById('phoneSetup').classList.add('hidden');
            document.getElementById('loadingStatus').classList.remove('hidden');
            
            // Geolocation Support pr√ºfen
            if (navigator.geolocation) {
                console.log('‚úÖ Geolocation wird unterst√ºtzt');
                console.log('‚è±Ô∏è Starte GPS-Ortung (Timeout: 15s)...');
                
                navigator.geolocation.getCurrentPosition(
                    onLocationSuccess,
                    onLocationError,
                    {
                        enableHighAccuracy: true,
                        timeout: 15000,
                        maximumAge: 0
                    }
                );
            } else {
                console.error('‚ùå Geolocation wird nicht unterst√ºtzt');
                showError('Dein Browser unterst√ºtzt keine Ortung');
            }
        }

        function onLocationSuccess(position) {
            console.log('üéØ GPS-Position erfolgreich ermittelt!');
            console.log('üìä Position Details:', {
                latitude: position.coords.latitude,
                longitude: position.coords.longitude,
                accuracy: position.coords.accuracy + 'm',
                timestamp: new Date(position.timestamp)
            });
            
            currentLocation = {
                lat: position.coords.latitude,
                lng: position.coords.longitude,
                accuracy: position.coords.accuracy,
                timestamp: new Date()
            };
            
            console.log('üé® Zeige Position in UI...');
            displayLocation();
            console.log('üåç Starte Adress-Ermittlung und SMS...');
            getAddressAndSendSMS();
        }

        function onLocationError(error) {
            console.error('‚ùå GPS-Ortung fehlgeschlagen!');
            console.error('üîç Error Details:', {
                code: error.code,
                message: error.message,
                timestamp: new Date()
            });
            
            let message = 'Ortung fehlgeschlagen: ';
            
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    message += 'Standortzugriff verweigert. Bitte in den Browsereinstellungen erlauben.';
                    console.error('üö´ Benutzer hat Standortzugriff verweigert');
                    break;
                case error.POSITION_UNAVAILABLE:
                    message += 'Position nicht verf√ºgbar';
                    console.error('üìç Position nicht verf√ºgbar (kein GPS/Netzwerk?)');
                    break;
                case error.TIMEOUT:
                    message += 'Timeout. Bitte erneut versuchen.';
                    console.error('‚è∞ GPS-Timeout nach 15 Sekunden');
                    break;
                default:
                    message += 'Unbekannter Fehler';
                    console.error('‚ùì Unbekannter Geolocation-Fehler');
            }
            
            showError(message);
        }

        function displayLocation() {
            // Loading ausblenden
            document.getElementById('loadingStatus').classList.add('hidden');
            
            // Location-Box anzeigen
            const locationBox = document.getElementById('locationResult');
            locationBox.classList.remove('hidden');
            
            // Daten einf√ºgen
            document.getElementById('coords').textContent = 
                `${currentLocation.lat.toFixed(6)}, ${currentLocation.lng.toFixed(6)}`;
            
            document.getElementById('time').textContent = 
                currentLocation.timestamp.toLocaleString('de-DE');
        }

        function getAddressAndSendSMS() {
            // Adresse ermitteln (optional)
            fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${currentLocation.lat}&longitude=${currentLocation.lng}&localityLanguage=de`)
                .then(response => response.json())
                .then(data => {
                    const address = data.display_name || 
                                  `${data.locality || ''} ${data.principalSubdivision || ''}`.trim() || 
                                  'Adresse nicht verf√ºgbar';
                    
                    document.getElementById('address').textContent = address;
                })
                .catch(() => {
                    document.getElementById('address').textContent = 'Adresse nicht verf√ºgbar';
                });
            
            // SMS senden (kurz warten f√ºr bessere UX)
            setTimeout(() => {
                sendSMS();
            }, 1500);
        }

        function sendSMS() {
            const mapsUrl = `https://maps.google.com/maps?q=${currentLocation.lat},${currentLocation.lng}`;
            console.log('üó∫Ô∏è Google Maps URL:', mapsUrl);
            
            const smsText = `üöó Auto geparkt!

üìç ${mapsUrl}

üïê ${currentLocation.timestamp.toLocaleString('de-DE')}`;

            console.log('üì± SMS Text erstellt:', smsText);

            const smsUrl = `sms:${phoneNumber}?body=${encodeURIComponent(smsText)}`;
            console.log('üîó SMS URL:', smsUrl);
            
            try {
                console.log('üì§ √ñffne SMS-App...');
                // SMS-App √∂ffnen
                window.location.href = smsUrl;
                
                console.log('‚úÖ SMS-App sollte sich ge√∂ffnet haben');
                console.log('‚è±Ô∏è Reset in 3 Sekunden f√ºr n√§chsten Scan');
                
                // Nach 3 Sekunden f√ºr n√§chsten Scan zur√ºcksetzen
                setTimeout(() => {
                    console.log('üîÑ App wird f√ºr n√§chsten Scan zur√ºckgesetzt');
                    resetApp();
                }, 3000);
                
            } catch (error) {
                console.error('‚ùå Fehler beim √ñffnen der SMS-App:', error);
                console.log('üìã Fallback: Kopiere in Zwischenablage');
                // Fallback: Text in Zwischenablage
                copyToClipboard(smsText);
            }
        }

        function copyToClipboard(text) {
            if (navigator.clipboard) {
                navigator.clipboard.writeText(text).then(() => {
                    alert('üìã Parkposition wurde in die Zwischenablage kopiert!');
                });
            }
        }

        function showError(message) {
            document.getElementById('loadingStatus').classList.add('hidden');
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorStatus').classList.remove('hidden');
            
            // Nach 4 Sekunden zur√ºcksetzen
            setTimeout(() => {
                resetApp();
            }, 4000);
        }

        function resetApp() {
            // Alles ausblenden
            document.getElementById('loadingStatus').classList.add('hidden');
            document.getElementById('locationResult').classList.add('hidden');
            document.getElementById('errorStatus').classList.add('hidden');
            
            // Telefon-Setup wieder anzeigen
            document.getElementById('phoneSetup').classList.remove('hidden');
        }
    </script>
</body>
</html>
